name: Docker Image

on:
  push:
    branches: [ 'devnet_*', 'testnet_*' ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-push:
    runs-on: linera-io-self-hosted-ci
    timeout-minutes: 40

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auth service account
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_ACTIONS_RUNNER_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Set env variables
        run: |
          # Set basic variables
          if [ -n "${{ github.head_ref }}" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi

          echo "GIT_COMMIT_SHORT=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "GIT_COMMIT_LONG=${GITHUB_SHA}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV

          # Build configuration
          echo "BUILD_TIMEOUT=3h" >> $GITHUB_ENV
          echo "BUILD_MACHINE_TYPE=e2-highcpu-32" >> $GITHUB_ENV

          # Image registry base
          REGISTRY_BASE="us-docker.pkg.dev/linera-io-dev/linera-public-registry"
          LINERA_IMAGE_NAME="linera"
          INDEXER_IMAGE_NAME="linera-indexer"
          EXPLORER_IMAGE_NAME="linera-explorer"
          EXPORTER_IMAGE_NAME="linera-exporter"

          # Main linera image names
          echo "LINERA_IMAGE_BRANCH=${REGISTRY_BASE}/${LINERA_IMAGE_NAME}:${BRANCH_NAME}" >> $GITHUB_ENV
          echo "LINERA_IMAGE_SHORT=${REGISTRY_BASE}/${LINERA_IMAGE_NAME}:${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "LINERA_IMAGE_LONG=${REGISTRY_BASE}/${LINERA_IMAGE_NAME}:${GITHUB_SHA}" >> $GITHUB_ENV

          # Indexer image names
          echo "INDEXER_IMAGE_BRANCH=${REGISTRY_BASE}/${INDEXER_IMAGE_NAME}:${BRANCH_NAME}" >> $GITHUB_ENV
          echo "INDEXER_IMAGE_SHORT=${REGISTRY_BASE}/${INDEXER_IMAGE_NAME}:${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "INDEXER_IMAGE_LONG=${REGISTRY_BASE}/${INDEXER_IMAGE_NAME}:${GITHUB_SHA}" >> $GITHUB_ENV

          # Explorer image names
          echo "EXPLORER_IMAGE_BRANCH=${REGISTRY_BASE}/${EXPLORER_IMAGE_NAME}:${BRANCH_NAME}" >> $GITHUB_ENV
          echo "EXPLORER_IMAGE_SHORT=${REGISTRY_BASE}/${EXPLORER_IMAGE_NAME}:${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "EXPLORER_IMAGE_LONG=${REGISTRY_BASE}/${EXPLORER_IMAGE_NAME}:${GITHUB_SHA}" >> $GITHUB_ENV

          # Exporter image names
          echo "EXPORTER_IMAGE_BRANCH=${REGISTRY_BASE}/${EXPORTER_IMAGE_NAME}:${BRANCH_NAME}" >> $GITHUB_ENV
          echo "EXPORTER_IMAGE_SHORT=${REGISTRY_BASE}/${EXPORTER_IMAGE_NAME}:${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "EXPORTER_IMAGE_LONG=${REGISTRY_BASE}/${EXPORTER_IMAGE_NAME}:${GITHUB_SHA}" >> $GITHUB_ENV

      - name: Build and push all images in parallel using GCP Cloud Build
        run: |
          set -e

          # Function to submit a build and return the build ID
          submit_build() {
            local CONFIG_FILE=$1
            local IMAGE_BRANCH=$2
            local IMAGE_SHORT=$3
            local IMAGE_LONG=$4
            local BUILD_NAME=$5

            BUILD_ID=$(gcloud builds submit . \
              --config="$CONFIG_FILE" \
              --substitutions="_IMAGE_PATH=${IMAGE_BRANCH},_IMAGE_NAME_SHORT_COMMIT=${IMAGE_SHORT},_IMAGE_NAME_LONG_COMMIT=${IMAGE_LONG},_GIT_COMMIT=${{ env.GIT_COMMIT_LONG }},_BUILD_DATE=${{ env.BUILD_DATE }},_BUILD_FLAG=--release,_BUILD_FOLDER=release" \
              --timeout="${{ env.BUILD_TIMEOUT }}" \
              --machine-type="${{ env.BUILD_MACHINE_TYPE }}" \
              --async \
              --format="value(id)")
            echo "$BUILD_NAME build submitted: $BUILD_ID" >&2
            echo "$BUILD_ID"
          }

          # Function to stream logs and wait for build completion
          stream_build_logs() {
            local BUILD_ID=$1
            local BUILD_NAME=$2

            echo "========================================"
            echo "Streaming logs for $BUILD_NAME (ID: $BUILD_ID)"
            echo "========================================"

            # Stream logs (exit code only reflects log streaming, not build result)
            gcloud builds log "$BUILD_ID" --stream || true

            # Check the actual Cloud Build status
            local BUILD_STATUS
            BUILD_STATUS=$(gcloud builds describe "$BUILD_ID" --format="value(status)")

            if [[ "$BUILD_STATUS" == "SUCCESS" ]]; then
              echo ""
              echo "$BUILD_NAME completed successfully (status: $BUILD_STATUS)"
            else
              echo ""
              echo "$BUILD_NAME failed (status: $BUILD_STATUS)"
              echo "Logs: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=linera-io-dev"
              return 1
            fi
          }

          echo "Submitting builds to GCP Cloud Build..."

          # Submit all builds
          BUILD_ID_LINERA=$(submit_build "docker/build-image.yaml" \
            "${{ env.LINERA_IMAGE_BRANCH }}" "${{ env.LINERA_IMAGE_SHORT }}" "${{ env.LINERA_IMAGE_LONG }}" "Linera")

          BUILD_ID_INDEXER=$(submit_build "docker/build-indexer-image.yaml" \
            "${{ env.INDEXER_IMAGE_BRANCH }}" "${{ env.INDEXER_IMAGE_SHORT }}" "${{ env.INDEXER_IMAGE_LONG }}" "Indexer")

          BUILD_ID_EXPLORER=$(submit_build "docker/build-explorer-image.yaml" \
            "${{ env.EXPLORER_IMAGE_BRANCH }}" "${{ env.EXPLORER_IMAGE_SHORT }}" "${{ env.EXPLORER_IMAGE_LONG }}" "Explorer")

          BUILD_ID_EXPORTER=$(submit_build "docker/build-exporter-image.yaml" \
            "${{ env.EXPORTER_IMAGE_BRANCH }}" "${{ env.EXPORTER_IMAGE_SHORT }}" "${{ env.EXPORTER_IMAGE_LONG }}" "Exporter")

          echo ""
          echo "All builds submitted. Now streaming logs and waiting for completion..."
          echo ""

          # Stream all builds in parallel
          stream_build_logs "$BUILD_ID_LINERA" "Linera build" &
          PID_LINERA=$!
          stream_build_logs "$BUILD_ID_INDEXER" "Indexer build" &
          PID_INDEXER=$!
          stream_build_logs "$BUILD_ID_EXPLORER" "Explorer build" &
          PID_EXPLORER=$!
          stream_build_logs "$BUILD_ID_EXPORTER" "Exporter build" &
          PID_EXPORTER=$!

          # Wait for all background jobs and check exit codes
          EXIT_CODE=0
          wait $PID_LINERA || EXIT_CODE=$?
          wait $PID_INDEXER || EXIT_CODE=$?
          wait $PID_EXPLORER || EXIT_CODE=$?
          wait $PID_EXPORTER || EXIT_CODE=$?

          if [[ $EXIT_CODE -ne 0 ]]; then
            echo ""
            echo "One or more image builds failed"
            exit $EXIT_CODE
          fi

          echo ""
          echo "All image builds completed successfully!"
