services:
  web:
    image: caddy:2.10.2-alpine
    container_name: web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - DOMAIN=${DOMAIN:-localhost}
    labels:
      com.centurylinklabs.watchtower.enable: "true"

  scylla-setup:
    image: ubuntu:24.04
    container_name: scylla-setup
    privileged: true
    volumes:
      - /proc:/host/proc
      - /sys:/host/sys
      - /etc/sysctl.d:/host/sysctl.d
      - ./compose-scylla-setup.sh:/setup.sh:ro
    command: ["/bin/bash", "/setup.sh", "--persist"]
    restart: "no"

  scylla:
    image: scylladb/scylla:6.2.3
    container_name: scylla
    volumes:
      - linera-scylla-data:/var/lib/scylla
    environment:
      SCYLLA_AUTO_CONF: 1
    command:
      - "--developer-mode"
      - "0"
      - "--overprovisioned"
      - "1"
    depends_on:
      scylla-setup:
        condition: service_completed_successfully

  proxy:
    image: "${LINERA_IMAGE:-us-docker.pkg.dev/linera-io-dev/linera-public-registry/linera:testnet_conway_release}"
    container_name: proxy
    ports:
      - "19100:19100"
    command:
      - ./linera-proxy
      - --storage
      - scylladb:tcp:scylla:9042
      - --storage-replication-factor
      - "1"
      - --storage-max-cache-size
      - "10000000"
      - --storage-max-value-entry-size
      - "1000000"
      - --storage-max-find-keys-entry-size
      - "1000000"
      - --storage-max-find-key-values-entry-size
      - "1000000"
      - --storage-max-cache-entries
      - "1000"
      - --storage-max-cache-value-size
      - "10000000"
      - --storage-max-cache-find-keys-size
      - "10000000"
      - --storage-max-cache-find-key-values-size
      - "10000000"
      - /config/server.json
    volumes:
      - .:/config
    labels:
      com.centurylinklabs.watchtower.enable: "true"
    depends_on:
      shard-init:
        condition: service_completed_successfully

  shard:
    image: "${LINERA_IMAGE:-us-docker.pkg.dev/linera-io-dev/linera-public-registry/linera:testnet_conway_release}"
    deploy:
      replicas: 4
    command:
      - ./linera-server
      - run
      - --storage
      - scylladb:tcp:scylla:9042
      - --server
      - /config/server.json
      - --shard
      - "0"
      - --storage-replication-factor
      - "1"
      - --storage-max-cache-size
      - "10000000"
      - --storage-max-value-entry-size
      - "1000000"
      - --storage-max-find-keys-entry-size
      - "1000000"
      - --storage-max-find-key-values-entry-size
      - "1000000"
      - --storage-max-cache-entries
      - "1000"
      - --storage-max-cache-value-size
      - "10000000"
      - --storage-max-cache-find-keys-size
      - "10000000"
      - --storage-max-cache-find-key-values-size
      - "10000000"
    volumes:
      - .:/config
    labels:
      com.centurylinklabs.watchtower.enable: "true"
    depends_on:
      shard-init:
        condition: service_completed_successfully

  shard-init:
    image: "${LINERA_IMAGE:-us-docker.pkg.dev/linera-io-dev/linera-public-registry/linera:testnet_conway_release}"
    container_name: shard-init
    command:
      - sh
      - -c
      - |
        while true; do
          ./linera storage check-existence --storage scylladb:tcp:scylla:9042
          status=$$?
          if [ $$status -eq 0 ]; then
            echo "Database already exists, no need to initialize."
            exit 0
          elif [ $$status -eq 1 ]; then
            echo "Database does not exist, attempting to initialize..."
            if ./linera storage initialize --storage scylladb:tcp:scylla:9042 --genesis /config/genesis.json; then
              echo "Initialization successful."
              exit 0
            else
              echo "Initialization failed, retrying in 5 seconds..."
              sleep 5
            fi
          else
            echo "An unexpected error occurred (status: $$status), retrying in 5 seconds..."
            sleep 5
          fi
        done
    volumes:
      - .:/config
    depends_on:
      scylla-setup:
        condition: service_completed_successfully
      scylla:
        condition: service_started

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3000:3000"
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./dashboards:/var/lib/grafana/dashboards

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: ["--interval", "30"]

volumes:
  linera-scylla-data:
    driver: local
  grafana-storage:
  caddy_data:
    driver: local
  caddy_config:
    driver: local
