{
    email {$ACME_EMAIL:admin@example.com}
}

{$DOMAIN:localhost} {
    # Automatic HTTPS with Let's Encrypt (or self-signed for localhost)

    # Handle OPTIONS preflight requests (let backend handle CORS headers)
    @options {
        method OPTIONS
    }
    handle @options {
        reverse_proxy https://proxy:443 {
            transport http {
                versions 2
                tls_insecure_skip_verify
            }
        }
    }

    # Simple reverse proxy for all gRPC traffic
    # Let the backend handle both gRPC and gRPC-Web (including CORS)
    reverse_proxy https://proxy:443 {
        # Configure for gRPC with self-signed certificate
        transport http {
            # Use HTTP/2 for gRPC
            versions 2

            dial_timeout 10s
            response_header_timeout 10s

            # Skip TLS verification for self-signed certificates
            tls_insecure_skip_verify

            keepalive 90s
            keepalive_idle_conns 64
        }

        # Disable buffering for gRPC streaming
        flush_interval -1
    }

    # Enable access logs in JSON format
    log {
        output stdout
        format json
    }
}
