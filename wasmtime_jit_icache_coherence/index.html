<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This crate provides utilities for instruction cache maintenance for JIT authors."><title>wasmtime_jit_icache_coherence - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-6c3ea77c.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="wasmtime_jit_icache_coherence" data-themes="" data-resource-suffix="" data-rustdoc-version="1.86.0 (05f9846f8 2025-03-31)" data-channel="1.86.0" data-search-js="search-581efc7a.js" data-settings-js="settings-6dad6058.js" ><script src="../static.files/storage-3a5871a4.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-4d63596a.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-893ab5e7.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../wasmtime_jit_icache_coherence/index.html">wasmtime_<wbr>jit_<wbr>icache_<wbr>coherence</a><span class="version">25.0.3</span></h2></div><div class="sidebar-elems"><ul class="block"><li><a id="all-types" href="all.html">All Items</a></li></ul><section id="rustdoc-toc"><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#usage" title="Usage">Usage</a><ul><li><a href="#example" title="Example:">Example:</a></li></ul></li></ul><h3><a href="#functions">Crate Items</a></h3><ul class="block"><li><a href="#functions" title="Functions">Functions</a></li></ul></section><div id="rustdoc-modnav"></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Crate <span>wasmtime_jit_icache_coherence</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../src/wasmtime_jit_icache_coherence/lib.rs.html#1-109">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This crate provides utilities for instruction cache maintenance for JIT authors.</p>
<p>In self modifying codes such as when writing a JIT, special care must be taken when marking the
code as ready for execution. On fully coherent architectures (X86, S390X) the data cache (D-Cache)
and the instruction cache (I-Cache) are always in sync. However this is not guaranteed for all
architectures such as AArch64 where these caches are not coherent with each other.</p>
<p>When writing new code there may be a I-cache entry for that same address which causes the
processor to execute whatever was in the cache instead of the new code.</p>
<p>See the <a href="https://community.arm.com/arm-community-blogs/b/architectures-and-processors-blog/posts/caches-and-self-modifying-code">ARM Community - Caches and Self-Modifying Code</a> blog post that contains a great
explanation of the above. (It references AArch32 but it has a high level overview of this problem).</p>
<h3 id="usage"><a class="doc-anchor" href="#usage">§</a>Usage</h3>
<p>You should call <a href="fn.clear_cache.html" title="fn wasmtime_jit_icache_coherence::clear_cache">clear_cache</a> on any pages that you write with the new code that you’re intending
to execute. You can do this at any point in the code from the moment that you write the page up to
the moment where the code is executed.</p>
<p>You also need to call <a href="fn.pipeline_flush_mt.html" title="fn wasmtime_jit_icache_coherence::pipeline_flush_mt">pipeline_flush_mt</a> to ensure that there isn’t any invalid instruction currently
in the pipeline if you are running in a multi threaded environment.</p>
<p>For single threaded programs you are free to omit <a href="fn.pipeline_flush_mt.html" title="fn wasmtime_jit_icache_coherence::pipeline_flush_mt">pipeline_flush_mt</a>, otherwise you need to
call both <a href="fn.clear_cache.html" title="fn wasmtime_jit_icache_coherence::clear_cache">clear_cache</a> and <a href="fn.pipeline_flush_mt.html" title="fn wasmtime_jit_icache_coherence::pipeline_flush_mt">pipeline_flush_mt</a> in that order.</p>
<h4 id="example"><a class="doc-anchor" href="#example">§</a>Example:</h4>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// Invalidate the cache for all the newly written pages where we wrote our new code.
</span><span class="kw">for </span>page <span class="kw">in </span>newly_written_pages {
    clear_cache(page.addr, page.len)<span class="question-mark">?</span>;
}

<span class="comment">// Once those are invalidated we also need to flush the pipeline
</span>pipeline_flush_mt()<span class="question-mark">?</span>;

<span class="comment">// We can now safely execute our new code.
</span>run_code();</code></pre></div>
<div class="example-wrap" style="display:inline-block"><pre class="compile_fail" style="white-space:normal;font:inherit;">
<p><strong>Warning</strong>: In order to correctly use this interface you should always call <a href="fn.clear_cache.html" title="fn wasmtime_jit_icache_coherence::clear_cache">clear_cache</a>.
A followup call to <a href="fn.pipeline_flush_mt.html" title="fn wasmtime_jit_icache_coherence::pipeline_flush_mt">pipeline_flush_mt</a> is required if you are running in a multi-threaded environment.</p>
<p></pre></div></p>
</div></details><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><dl class="item-table"><dt><a class="fn" href="fn.clear_cache.html" title="fn wasmtime_jit_icache_coherence::clear_cache">clear_<wbr>cache</a><sup title="unsafe function">⚠</sup></dt><dd>Flushes the instruction cache for a region of memory.</dd><dt><a class="fn" href="fn.pipeline_flush_mt.html" title="fn wasmtime_jit_icache_coherence::pipeline_flush_mt">pipeline_<wbr>flush_<wbr>mt</a></dt><dd>Flushes instructions in the processor pipeline</dd></dl></section></div></main></body></html>